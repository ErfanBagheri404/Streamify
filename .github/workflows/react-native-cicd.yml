  name: React Native CI/CD

  on:
    push:
      branches: [main, master]
      paths-ignore:
        - "**.md"
        - "LICENSE"
        - "docs/**"
    pull_request:
      branches: [main, master]
    workflow_dispatch:
      inputs:
        buildType:
          type: choice
          description: "Build type to run"
          options:
            - prod-apk # <-- changed from 'dev'
            - all

  env:
    EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
    NODE_OPTIONS: --openssl-legacy-provider

  jobs:
    check-skip:
      runs-on: ubuntu-latest
      if: "!contains(github.event.head_commit.message, '[skip ci]')"
      steps:
        - name: Skip CI check
          run: echo "Proceeding with workflow"

    build-and-deploy:
      needs: check-skip
      if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) || github.event_name == 'workflow_dispatch'
      runs-on: ubuntu-latest
      steps:
        - name: ðŸ— Checkout repository
          uses: actions/checkout@v4

        - name: ðŸ— Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: "20"
            cache: "npm"

        - name: ðŸ“¦ Install dependencies
          run: |
            npm ci --include=dev
            npm install -g eas-cli@latest

        - name: ðŸ“± Setup EAS build cache
          uses: actions/cache@v3
          with:
            path: ~/.eas-build-local
            key: ${{ runner.os }}-eas-build-local-${{ hashFiles('**/package.json') }}
            restore-keys: |
              ${{ runner.os }}-eas-build-local-

        - name: ðŸ”„ Verify EAS CLI installation
          run: |
            echo "EAS CLI version:"
            eas --version

        - name: ðŸ“‹ Fix package.json main entry
          run: |
            if ! command -v jq &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y jq
            fi
            cp package.json package.json.bak
            jq '.main = "node_modules/expo/AppEntry.js"' package.json > package.json.tmp && mv package.json.tmp package.json
            cat package.json | grep "main"

        - name: ðŸ“‹ Update metro.config.js for SVG support
          run: |
            if [ -f ./metro.config.js ]; then
              cp ./metro.config.js ./metro.config.js.backup
              cat > ./metro.config.js << 'EOFMARKER'
            /* eslint-disable @typescript-eslint/no-var-requires */
            const { getDefaultConfig } = require('expo/metro-config');
            const config = getDefaultConfig(__dirname);
            const { transformer, resolver } = config;
            config.transformer = {
              ...transformer,
              babelTransformerPath: require.resolve('react-native-svg-transformer/expo'),
            };
            config.resolver = {
              ...resolver,
              assetExts: resolver.assetExts.filter(ext => ext !== 'svg'),
              sourceExts: [...resolver.sourceExts, 'svg'],
            };
            module.exports = config;
            EOFMARKER
            fi

        # ----------------------------------------------------------
        #  PREBUILD - Generate native Android files
        # ----------------------------------------------------------
        - name: ðŸ— Run Prebuild (Generate Android files)
          run: |
            echo "Running prebuild to generate Android directory..."
            npx expo prebuild --platform android --clean

        # ----------------------------------------------------------
        #  PRODUCTION build (standalone, offline, no Metro required)
        # ----------------------------------------------------------
        - name: ðŸ“± Build Production APK
          if: github.event.inputs.buildType == 'all' || github.event.inputs.buildType == 'prod-apk' || github.event_name == 'push'
          run: |
            export NODE_OPTIONS="--openssl-legacy-provider --max_old_space_size=4096"
            rm -rf android/app/build
            eas build --platform android --profile production-apk --local --non-interactive --output=./app-prod.apk
            if [ -f ./app-prod.apk ]; then
              echo "APK file created successfully"
              ls -la ./app-prod.apk
              unzip -t ./app-prod.apk > /dev/null && echo "APK structure is valid" || echo "WARNING: APK structure validation failed"
            else
              echo "ERROR: APK file was not created"
              exit 1
            fi
          env:
            NODE_ENV: production
            # Add this block
            ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
            ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
            ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}



        - name: ðŸ” Print Gradle log (if failed)
          if: failure()
          run: |
            LOG=$(ls -t ./logs/*.log 2>/dev/null | head -n1)
            if [ -f "$LOG" ]; then cat "$LOG"; else echo "No gradle log found"; fi

        - name: ðŸ“¦ Upload production APK
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: app-prod-apk
            path: ./app-prod.apk
            retention-days: 7
